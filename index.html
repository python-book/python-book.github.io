<!doctype html>
<html lang="zh-CN">
  <title>Python语言程序设计入门教程</title>
  <head>
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <meta charset=utf-8>
        <!-- <script src="pyodide/pyodide.js"> </script> -->
    <script src="https://cdn.jsdelivr.net/pyodide/v0.26.1/full/pyodide.js"></script>
    <link rel="stylesheet" href="codemirror-5.65.16/lib/codemirror.css">
    <link rel=stylesheet href="codemirror-5.65.16/doc/docs.css">
    <script src="codemirror-5.65.16/lib/codemirror.js"></script>
    <script src="codemirror-5.65.16/addon/edit/matchbrackets.js"></script>
    <script src="codemirror-5.65.16/mode/python/python.js"></script>
    <script src="lib/fileops.js"></script>
    <script src="lib/githubops.js"></script>

    <style>
      .intro-container {
        width: 100%;
        height: 12vh;
        max-height: 138px;
        display: flex;
        overflow: auto;
        flex-direction: column;
        justify-content: center;
        align-items: center;
        text-align: center;
      }
      .editor-container {
        width: 100%;
        height: 55vh;
        /*max-height: 800px; /* maximum height for the container */
        border: 1px solid #ccc;
        overflow: hidden; /*hide overflow to control textarea size*/
        position: relative;
      }
      #tab-container {
        display: flex;
        overflow-x: auto;
        width: 100%;
        height: 40px; /* Adjust height as needed */
        border-bottom: 1px solid #ccc;
      }
      #tab-only-container {
        display: inline-flex;
        overflow-x: auto;
        height: 40px; /* Adjust height as needed */
        border-bottom: 1px solid #ccc;
      }
      .tab {
        display: flex;
        align-items: center;
        padding: 5px 10px;
        background-color: #f0f0f0;
        margin-right: 5px;
        border-radius: 5px 10px 0 0;
      }
      .tab.active {
        background-color: #e0e0e0;
        border-bottom: 2px solid #007bff;
      }
      .tab-button {
        display: inline-flex;
        background: none;
        border: none;
        cursor: pointer;
        font-weight: bold;
        margin-right: 1px;
      }
      #add-tab {
        /* ... style the add tab button ... */
        color:green;
      }

      .code-editor-container {
        display: flex;;
        left: 0;
        width: 100%;
        height: calc(100% - 80px); /* Adjust height as needed */
        border: 1px solid #0d09ef;
        overflow: hidden;
      }
      .code-editor-wrapper {
        position: relative;
        left: 0;
        width: 100%;
        height: calc(100% - 80px); /* Adjust height as needed */
        border: 1px solid #ef0909;
        overflow: hidden;
      }

      .CodeMirror {
        height: 95%;
      }
      .output-container {
        width: 100%;
        height: 32vh;
        /*max-height: 400px; /* maximum height for the container */
        border: 1px solid #ccc;
        overflow: hidden; /*hide overflow to control textarea size*/
        position: relative;
      }
      .editable {
        width: 100%;
        height: 98%;
        border: 1px solid #ccc;
        padding: 2px;
        overflow-y: auto;
        white-space: pre-wrap;
      }
      .red-text {
        color: red;
      }
      #output {
        width: 100%;
        box-sizing: border-box; /* ensures padding is included in width calculation */
        overflow-y: auto; /* adds scroll bar when content exceeds max height */
        resize: none; /* disable manual resizing */
      }
      .resize-handle {
        width: 100%;
        height: 10px;
        background-color: #6f6b6b;
        cursor: ns-resize;
        position: absolute;
        bottom: 0;
        left: 0;
        text-align: center;
        align-content:center;
      }
      #clearOutput {
        position: absolute;
        top: 5px;
        right: 10px;
        background: none;
        border: none;
        cursor: pointer;
        padding: 0;
        width: 24px;
        height: 24px;
      }
      #clearOutput::before, #clearOutput::after {
        content: '';
        position: absolute;
        top: 50%;
        left: 50%;
        width: 16px;
        height: 2px;
        background-color: black;
      }
      #clearOutput::before {
        transform: translate(-50%, -50%) rotate(45deg);
      }
      #clearOutput::after {
        transform: translate(-50%, -50%) rotate(-45deg);
      }
      #gitrepo-content-popup {
        display: none;
        position: absolute;
        top: 45%;
        left: 50%;
        transform: translate(-50%, -50%);
        border: 1px solid #000;
        background: #fff;
        padding: 20px;
        width: 80%;
        height: 80%;
        overflow-y: auto;
        box-shadow: 0 4px 8px rgba(0,0,0,0.1);
      }
      #gitrepo-content-popup ul {
        list-style-type: none;
        padding: 0;
      }
      #gitrepo-content-popup ul li {
        margin: 5px 0;
      }
      #gitrepo-content-popup ul li a {
        text-decoration: none;
        color: #007bff;
      }
      #gitrepo-content-popup ul li a:hover {
        text-decoration: underline;
      }
    </style>
  </head>

  <body style="overflow: auto; padding: 2px;padding-right: 5px;">
    <div id="language-switcher" style="position: absolute; top: 10px; right: 10px;">
      <button onclick="switchLanguage('en')">English</button>
      <button onclick="switchLanguage('zh')">中文</button>
    </div>
    <div class="intro-container">
      <h2 id="title">《Python语言程序设计入门教程》</h2>
      <p id="intro">
        在线Python运行环境，无需安装，直接在以下程序编辑窗编辑源代码，然后按&#x25B6;执行。
        可以用“打开本书示例”按钮直接浏览，打开本书提供的示例。
      </p>
      <p id="warning">注意：这是一个虚拟机，虽然可以进行文件操作，但是一旦关闭本网页，保存在虚拟机里的文件会被清空。</p>
    </div>
    <!-- <div class="editor-container" id="editor-container">
      <textarea style="height: 700px;" id="code-editor"></textarea>
      <div class="resize-handle" id="resizeHandle" style="text-align: center;">| | |</div>
      <div id="gitrepo-content-popup" hidden>
        <h2 id="repo-title">Repository Contents</h2>
        <ul id="gitRepofileList"></ul>
        <button onclick="closePopup()">Close</button>
      </div>
      <button id="run" onclick="evaluatePython()" title="Run(Ctrl+Enter)" style="color: green;" disabled>&#x25B6;</button>
      | <button id="open-virtual-file" onclick="showFSContents()">打开临时文件</button>
      | <button id="open-book-example" onclick="showRepoContents()">打开本书示例</button>
      | <button id="upload-file-button" onclick="uploadFileSelector()">传本机文件到虚拟机</button>
      <input type="file" id="upload-file-input" accept=".py" hidden>
    </div> -->
    <div class="editor-container" id="editor-container">
      <div id="tab-container">
        <div id="tab-only-container">
          <!-- <div class="tab active" data-tab-id="1"> -->
            <!-- <button class="tab-button">Tab 1</button> -->
          <!-- </div> -->
        </div>
        <button id="add-tab" onclick="addTab()">+</button>
      </div>
      <div class="code-editor-container" id="code-editor-container">
        <!-- <div class="code-editor-wrapper" data-tab-id="1"></div> -->
      </div>
      <div id="gitrepo-content-popup" hidden>
        <h2 id="repo-title">Repository Contents</h2>
        <ul id="gitRepofileList"></ul>
        <button onclick="closePopup()">Close</button>
      </div>
      <button id="run" onclick="evaluatePython()" title="Run(Ctrl+Enter)" style="color: green;" disabled>&#x25B6;</button>
      | <button id="open-virtual-file" onclick="showFSContents()">打开临时文件</button>
      | <button id="open-book-example" onclick="showRepoContents()">打开本书示例</button>
      | <button id="upload-file-button" onclick="uploadFileSelector()">传本机文件到虚拟机</button>
      <input type="file" id="upload-file-input" accept=".py" hidden>
    </div>
    

    <div class="output-container" id="output-container">
      <h3 id="output-title" style="height: 10px; vertical-align: top;">输出结果:</h3>
      <button id="clearOutput" aria-label="Close" title="clear output"></button>
      <div class="editable" contenteditable="true" id="styledText" tabindex="0"></div>
      <textarea id="output" hidden></textarea>
    </div>
    <input id="user_input" hidden>
    <script>      
      // document.addEventListener("DOMContentLoaded", function() {
      //   var textarea = document.getElementById("code-editor");
      //   var editor = CodeMirror.fromTextArea(textarea, {
      //       lineNumbers: true,
      //       mode: {name: "python",
      //          version: 3,
      //          singleLineStringErrors: false},
      //       indentUnit: 4,
      //       matchBrackets: true
      //   });
      //   window.editor = editor;
      // });

      // Function to create a new CodeMirror instance
      function createCodeMirror(tabId) {
        const codeEditorWrapper = document.querySelector(`.code-editor-wrapper[data-tab-id="${tabId}"]`);
        const textarea = document.createElement('textarea');
        codeEditorWrapper.appendChild(textarea);
        const editor = CodeMirror.fromTextArea(textarea, {
          lineNumbers: true,
          mode: { name: "python", version: 3, singleLineStringErrors: false },
          indentUnit: 4,
          matchBrackets: true
        });
        return editor;
      }

      // Create initial CodeMirror instances
      let codeMirrors = {};
      // const tabs = document.querySelectorAll('.tab');
      // tabs.forEach(tab => {
      //   const tabId = tab.dataset.tabId;
      //   codeMirrors[tabId] = createCodeMirror(tabId);
      // });
      // switchTab(1); // Switch to the first tab by default
      addTab();

      // Function to switch tabs
      function switchTab(tabId) {
        console.log(`switchTab is called to switch to ${tabId}`);
        const activeTab = document.querySelector('.tab.active');
        if (activeTab) {
          activeTab.classList.remove('active');
        }
        const targetTab = document.querySelector(`.tab[data-tab-id="${tabId}"]`);
        targetTab.classList.add('active');

        // Hide all code editors
        for (const editorId in codeMirrors) {
          console.log(`--hiding ${editorId}th editor`);
          codeMirrors[editorId].getWrapperElement().parentElement.style.display = 'none';
        }

        // Show the code editor for the selected tab
        codeMirrors[tabId].getWrapperElement().parentElement.style.display = 'block';
        window.editor = codeMirrors[tabId];
      }

      // Function to add a new tab
      function addTab() {
        const nextTabId = Object.keys(codeMirrors).length + 1;
        const newTabHTML = `
          <div class="tab" data-tab-id="${nextTabId}">
            <button class="tab-button">Tab ${nextTabId}</button>
          </div>
        `;
        const tabContainer = document.getElementById('tab-only-container');
        tabContainer.innerHTML += newTabHTML;

        const editorContainer = document.getElementById('code-editor-container');
        //editorContainer.innerHTML += `<div class="code-editor-wrapper" data-tab-id="${nextTabId}"></div>`;
        // let newEditorContainerHTML = "";
        // for (const editorId in codeMirrors) {
        //   newEditorContainerHTML += `<div class="code-editor-wrapper" data-tab-id="${editorId}" style="display: none;"></div>`;
        // }
        // editorContainer.innerHTML = newEditorContainerHTML + `<div class="code-editor-wrapper" data-tab-id="${nextTabId}"></div>`;
        editorWrapper = document.createElement('div');
        editorWrapper.classList.add('code-editor-wrapper');
        editorWrapper.setAttribute('data-tab-id', nextTabId);
        editorContainer.append(editorWrapper);
        // Create CodeMirror instance for the new tab
        codeMirrors[nextTabId] = createCodeMirror(nextTabId);

        // Add event listeners to tab buttons
        const tabButtons = document.querySelectorAll('.tab-button');
        tabButtons.forEach(button => {
          button.addEventListener('click', () => {
            const tabId = button.parentElement.dataset.tabId;
            switchTab(tabId);
          });
        });
        // Switch to the new tab
        switchTab(nextTabId);
      }


      function scrollToBottom(textarea) {
        textarea.scrollTop = textarea.scrollHeight;
      }

      // Add event listener for the clear button
      const clearOutputButton = document.getElementById('clearOutput');
      clearOutputButton.addEventListener('click', clearOutput);

      function clearOutput() {
        const styledTextDiv = document.getElementById('styledText');
        const outputTextarea = document.getElementById('output');

        // Clear the content of both elements
        styledTextDiv.innerHTML = '';
        outputTextarea.value = '';
        stdout_func(">>>")
      }


      const styledTextDiv = document.getElementById('styledText');
      styledTextDiv.setAttribute("contenteditable", false)

      let inputBuffer = "";
      let lastOutput = "";

      const stdin_func = () => {
        input = prompt(`Python is waiting for your input,\n${lastOutput}:`)
        stdout_func(input);
        return input + "\n";
      };

      const stdout_func = (output_) => {
        console.log(`stdout_func is called with ${output_}`)
        //const outputArea = document.getElementById("output");
        //outputArea.value += output_ + "\n";
        const styledTextDiv = document.getElementById('styledText');
        const hiddenTextarea = document.getElementById('output');
        styledTextDiv.innerHTML += output_ + "<br>";
        hiddenTextarea.value += output_ + "\n";
        scrollToBottom(styledTextDiv);
      };

      const stderr_func = (err) => {
        //const outputArea = document.getElementById("output");
        // outputArea.value += `Error: ${err}\n>>>\n`;
        // scrollToBottom(outputArea);
        const styledTextDiv = document.getElementById('styledText');
        const hiddenTextarea = document.getElementById('output');
        styledTextDiv.innerHTML += '<span class="red-text">' + err + "</span><br>";
        hiddenTextarea.value += err + "\n";
        scrollToBottom(styledTextDiv);
      };

      class OutputWriter {
        constructor() {
          console.log("Initializing OutputWriter...");
        }

        write(buffer) {
          console.log(`OutputWriter.write buffer=${buffer}`);
          const decoder = new TextDecoder('utf-8');
          const output = decoder.decode(buffer);
          const styledTextDiv = document.getElementById('styledText');
          const hiddenTextarea = document.getElementById('output');
          styledTextDiv.innerHTML += output ;
          hiddenTextarea.value += output ;
          lastOutput = output;
          scrollToBottom(styledTextDiv);
          console.log(`OutputWrite.write:${styledTextDiv.innerText}`)
          return output.length;
        }
      }

      const outputArea = document.getElementById("styledText");
      outputArea.innerHTML = "Initializing...<br>";

      // Resize functionality
      // const editorContainer = document.getElementById('editor-container');
      // const outputContainer = document.getElementById('output-container');
      // const resizeHandle = document.getElementById('resizeHandle');
      // let isResizing = false;

      // resizeHandle.addEventListener('mousedown', function(e) {
      //   isResizing = true;
      //   document.body.style.cursor = 'ns-resize';
      //   e.preventDefault(); // prevent text selection
      // });

      // document.addEventListener('mousemove', function(e) {
      //   if (!isResizing) return;
      //   const newHeight = e.clientY - editorContainer.getBoundingClientRect().top;
      //   editorContainer.style.height = `${newHeight}px`;
      //   adjustTextareaHeight(document.getElementById('code-editor'));
      //   adjustTextareaHeight(document.getElementById('output'));
      // });

      // document.addEventListener('mouseup', function(e) {
      //   if (isResizing) {
      //     isResizing = false;
      //     document.body.style.cursor = 'default';
      //   }
      // });

      // init Pyodide
      async function main() {
        let pyodide = await loadPyodide({
          indexURL: "https://cdn.jsdelivr.net/pyodide/v0.26.1/full/",
          stdin: stdin_func,
          //stdout: stdout_func,
          stderr: stderr_func
        });
        pyodide.setStdout(new OutputWriter());
        // Mount the subdirectory
        pyodide.FS.mkdir('/workdir');
        pyodide.FS.mount(pyodide.FS.filesystems.IDBFS, {}, '/workdir');
        
        // Set the current working directory to the subdirectory
        pyodide.FS.chdir('/workdir');
        
        // Sync the filesystem
        await pyodide.FS.syncfs(true,  function (err) {
          if (err) {
            console.error("Error syncing filesystem:", err);
          } else {
            document.getElementById("output").innerText = "Filesystem synced successfully";
          }
        });
        // let zipResponse = await fetch("https://github.com/python-book/python-book/archive/refs/heads/main.zip");
        // let zipBinary = await zipResponse.arrayBuffer();
        // pyodide.unpackArchive(zipBinary, "zip");
        
        // Pyodide is now ready to use with the subdirectory
        stdout_func("Ready!\n>>>");
        runButton = document.getElementById("run");
        runButton.disabled = false;
        return pyodide;
      }
      let pyodideReadyPromise = main();

      document.body.addEventListener("keyup", (event) => {
        const key = event.key;
        if (event.ctrlKey && key === "Enter") {
          evaluatePython();
        }
      });

      async function evaluatePython() {
        let pyodide = await pyodideReadyPromise;
        //const code = window.editor.getValue();
        const activeTabId = document.querySelector('.tab.active').dataset.tabId;
        const code = codeMirrors[activeTabId].getValue();
        //console.log("executing: "code)
        runButton = document.getElementById("run");
        runButton.disabled = true;
        try {
          let output = pyodide.runPython(code);
          stdout_func(">>>");
          runButton.disabled = false;
        } catch (err) {
          stderr_func(err);
          runButton.disabled = false;
        }
      }

      function switchLanguage(lang) {
        const title = document.getElementById('title');
        const intro = document.getElementById('intro');
        const warning = document.getElementById('warning');
        const repoTitle = document.getElementById('repo-title');
        const outputTitle = document.getElementById('output-title');

        if (lang === 'en') {
          title.textContent = 'Python Programming for Beginners';
          intro.textContent = 'Online Python running environment, no installation required. Edit the source code in the program editing window below, then click \u25B6 to execute.';
          warning.textContent = 'Note: This is a virtual machine. Although you can access file operations online, the content saved in the virtual machine will be cleared when you close this webpage.';
          repoTitle.textContent = 'Repository Contents';
          outputTitle.textContent = 'Output Results:';
          document.getElementById('open-virtual-file').textContent = 'Open VM file';
          document.getElementById('open-book-example').textContent = 'Open Example in the Book';
          document.getElementById('upload-file-button').textContent = 'Upload local File to VM';
        } else if (lang === 'zh') {
          title.textContent = '《Python语言程序设计入门教程》';
          intro.textContent = '在线Python运行环境，无需安装，直接在以下程序编辑窗编辑源代码，然后按 \u25B6 执行。\n可以用“打开本书示例”按钮直接浏览，打开本书提供的示例。';
          warning.textContent = '注意：这是一个虚拟机，虽然可以进行文件操作，但是一旦关闭本网页，保存在虚拟机里的文件会被清空。';
          repoTitle.textContent = 'Repository Contents';
          outputTitle.textContent = '输出结果:';
          document.getElementById('open-virtual-file').textContent = '打开临时文件';
          document.getElementById('open-book-example').textContent = '打开本书示例';
          document.getElementById('upload-file-button').textContent = '传本机文件到虚拟机';
        }
        document.documentElement.lang = lang;
      }

      // Initial language (you can change this)
      // Automatically detect browser language
      function detectLanguage() {
        const userLang = navigator.language || navigator.userLanguage;
        const lang = userLang.substring(0, 2).toLowerCase(); // Get the first two letters of the language code
        switchLanguage(lang);
      }

      // Call detectLanguage() on page load
      window.onload = detectLanguage;
    </script>
    
  </body>
</html>
